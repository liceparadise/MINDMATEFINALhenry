{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Manage Reminders - MindMate{% endblock %}

{% block extra_css %}
<style>
    .reminder-card {
        transition: transform 0.2s ease;
    }
    
    .reminder-card:hover {
        transform: translateY(-5px);
    }
    
    .reminder-time {
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .reminder-days {
        margin-top: 10px;
    }
    
    .day-badge {
        display: inline-block;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
        border-radius: 50%;
        margin-right: 5px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .day-active {
        background-color: #0d6efd;
        color: white;
    }
    
    .day-inactive {
        background-color: #e9ecef;
        color: #6c757d;
    }
    
    .empty-reminders {
        text-align: center;
        padding: 50px 0;
    }
    
    .empty-reminders i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Reminders</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReminderModal">
            <i class="fas fa-plus-circle me-2"></i>Add Reminder
        </button>
    </div>
    
    {% if reminders %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for reminder in reminders %}
                <div class="col">
                    <div class="card reminder-card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="reminder-time">{{ reminder.time|date:"g:i A" }}</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="reminder-{{ reminder.id }}-active" 
                                           {% if reminder.is_active %}checked{% endif %}
                                           data-reminder-id="{{ reminder.id }}">
                                    <label class="form-check-label" for="reminder-{{ reminder.id }}-active">Active</label>
                                </div>
                            </div>
                            
                            <div class="reminder-days">
                                <span class="day-badge {% if 'Monday' in reminder.days %}day-active{% else %}day-inactive{% endif %}">M</span>
                                <span class="day-badge {% if 'Tuesday' in reminder.days %}day-active{% else %}day-inactive{% endif %}">T</span>
                                <span class="day-badge {% if 'Wednesday' in reminder.days %}day-active{% else %}day-inactive{% endif %}">W</span>
                                <span class="day-badge {% if 'Thursday' in reminder.days %}day-active{% else %}day-inactive{% endif %}">T</span>
                                <span class="day-badge {% if 'Friday' in reminder.days %}day-active{% else %}day-inactive{% endif %}">F</span>
                                <span class="day-badge {% if 'Saturday' in reminder.days %}day-active{% else %}day-inactive{% endif %}">S</span>
                                <span class="day-badge {% if 'Sunday' in reminder.days %}day-active{% else %}day-inactive{% endif %}">S</span>
                            </div>
                            
                            <div class="mt-3">
                                <p class="mb-0">{{ reminder.message }}</p>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent d-flex justify-content-between">
                            <button type="button" class="btn btn-sm btn-outline-primary edit-reminder-btn"
                                    data-reminder-id="{{ reminder.id }}"
                                    data-reminder-time="{{ reminder.time|date:'H:i' }}"
                                    data-reminder-days="{{ reminder.days }}"
                                    data-reminder-message="{{ reminder.message }}"
                                    data-reminder-active="{{ reminder.is_active|lower }}"
                                    data-bs-toggle="modal" data-bs-target="#editReminderModal">
                                <i class="fas fa-edit me-1"></i>Edit
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    data-bs-toggle="modal" data-bs-target="#deleteReminderModal"
                                    data-reminder-id="{{ reminder.id }}"
                                    data-reminder-time="{{ reminder.time|date:'g:i A' }}">
                                <i class="fas fa-trash-alt me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-reminders">
            <i class="far fa-bell"></i>
            <h4>No reminders set</h4>
            <p class="text-muted">Set up reminders to help you remember to track your mood regularly.</p>
            <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addReminderModal">
                <i class="fas fa-plus-circle me-2"></i>Add Your First Reminder
            </button>
        </div>
    {% endif %}
</div>

<!-- Add Reminder Modal -->
<div class="modal fade" id="addReminderModal" tabindex="-1" aria-labelledby="addReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addReminderModalLabel">Add New Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'add_reminder' %}" novalidate>
                <div class="modal-body">
                    {% csrf_token %}
                    {{ form|crispy }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Reminder</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Reminder Modal -->
<div class="modal fade" id="editReminderModal" tabindex="-1" aria-labelledby="editReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReminderModalLabel">Edit Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editReminderForm" method="post" action="" novalidate>
                <div class="modal-body">
                    {% csrf_token %}
                    {{ form|crispy }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Reminder</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Reminder Modal -->
<div class="modal fade" id="deleteReminderModal" tabindex="-1" aria-labelledby="deleteReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteReminderModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this reminder?</p>
                <p id="deleteReminderTime" class="fw-bold"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteReminderForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle reminder active status
        const activeToggles = document.querySelectorAll('.form-check-input[data-reminder-id]');
        activeToggles.forEach(toggle => {
            toggle.addEventListener('change', function() {
                const reminderId = this.getAttribute('data-reminder-id');
                const isActive = this.checked;
                
                fetch(`{% url 'toggle_reminder' 0 %}`.replace('0', reminderId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ is_active: isActive })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        const message = isActive ? 'Reminder activated' : 'Reminder deactivated';
                        // You can add a toast notification here if desired
                    } else {
                        // Revert the toggle if there was an error
                        this.checked = !isActive;
                        alert('Failed to update reminder status');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.checked = !isActive;
                    alert('An error occurred while updating the reminder');
                });
            });
        });
        
        // Setup edit reminder modal
        const editButtons = document.querySelectorAll('.edit-reminder-btn');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const reminderId = this.getAttribute('data-reminder-id');
                const reminderTime = this.getAttribute('data-reminder-time');
                const reminderDays = this.getAttribute('data-reminder-days').split(',');
                const reminderMessage = this.getAttribute('data-reminder-message');
                const reminderActive = this.getAttribute('data-reminder-active') === 'true';
                
                // Set form action
                document.getElementById('editReminderForm').action = `{% url 'edit_reminder' 0 %}`.replace('0', reminderId);
                
                // Set form values
                document.getElementById('id_time').value = reminderTime;
                
                // Set days checkboxes
                const dayCheckboxes = document.querySelectorAll('input[name="days"]');
                dayCheckboxes.forEach(checkbox => {
                    checkbox.checked = reminderDays.includes(checkbox.value);
                });
                
                document.getElementById('id_message').value = reminderMessage;
                document.getElementById('id_is_active').checked = reminderActive;
            });
        });
        
        // Setup delete reminder modal
        const deleteModal = document.getElementById('deleteReminderModal');
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const reminderId = button.getAttribute('data-reminder-id');
            const reminderTime = button.getAttribute('data-reminder-time');
            
            // Set the reminder time in the modal
            document.getElementById('deleteReminderTime').textContent = `Reminder at ${reminderTime}`;
            
            // Set the form action
            document.getElementById('deleteReminderForm').action = `{% url 'delete_reminder' 0 %}`.replace('0', reminderId);
        });
    });
</script>
{% endblock %}